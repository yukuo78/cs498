<html>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src='https://d3js.org/d3.v5.min.js'></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">

<style> circle {
    /*fill: lightblue;*/
    stroke: black;
    opacity: 0.2
}

.annotation {
    opacity: 1;
    position: absolute;
    width: 120px;
    height: 70px;
    text-align: center;
    background-color: white;
    border: 3px solid orange;
    border-radius: 10px;
    padding: 2px
}
</style>
<body onload='init()'>
<div class="page-header">
    <h1>CS498 Project 2: <small>Narrative Visualization</small></h1>
</div>

<div class="row scatter">
    <div id="div_template" class="col-sm-9">
<!--        <svg width=900 height=600>-->
<!--        </svg>-->
    </div>
    <div class="col-sm-3">
        <h3>Navigation throgh here:</h3>
        <div class="btn-toolbar" role="toolbar" aria-label="...">
            <div class="btn-group" role="group" aria-label="...">
                <p>
                <div id="button1" class="btn btn-primary" onclick="changeScene(1)">1</div>
                <div id="button2" class="btn btn-default" onclick="changeScene(2)">2</div>
                <div id="button3" class="btn btn-default" onclick="changeScene(3)">3</div>
                </p>
            </div>
        </div>
        <div id="scene-desc" class="">
            <p>Looking at the chart, we can see a clear relationship between birth rate and income.
            People tends to give less birth if they are rich, and on the contrary the people in less wealthy
            countries tend to give more birth.</p>
        </div>

<!--        <h2>Year</h2>-->
<!--        <div class="row align-items-center">-->
<!--            <div class="col-sm-2"><p id="value-time"></p></div>-->
<!--            <div class="col-sm">-->
<!--                <div id="slider-time"></div>-->
<!--            </div>-->
<!--        </div>-->
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>

<script>
    var margin = {left: 50, top: 20, right: 20, bottom: 20},
        width = 800 - margin.left - margin.right,
        height = width * 2 / 3;

    var golbalSceneNumber = 1;
    var showToolTip = false;
    var showAnnotation1 = false;
    var showAnnotation2 = false;
    var showYearSelection = false;
    var regionSelect = "";

    function changeScene(sceneNumber) {
        golbalSceneNumber = sceneNumber;
        if (golbalSceneNumber === 1) {
            showToolTip = false;
            showAnnotation1 = true
            showAnnotation2 = false
            showYearSelection = false;
            d3.select("#scene-desc")
                .html("<p>Looking at the chart, we can see a clear relationship between birth rate and income." +
                    "People tends to give less birth if they are rich, and on the contrary the people in less wealthier tend to give more birth.</p>")
            d3.select("#div_template").html("")
            d3.selectAll(".btn").attr("class", "btn btn-default")
            d3.select("#button1").attr("class", "btn btn-primary")
            init()
        }
        if (golbalSceneNumber === 2) {
            showToolTip = false;
            showAnnotation1 = false;
            showAnnotation2 = true;
            showYearSelection = false;
            regionSelect = "Europe"
            d3.select("#scene-desc")
                .html("<p>But there are still regional difference. For example Europe is different. " +
                    "It seems all European countries tend to have very low birth rate, though their incomes vary much.</p>")
            d3.select("#div_template").html("")
            d3.selectAll(".btn").attr("class", "btn btn-default")
            d3.select("#button2").attr("class", "btn btn-primary")
            init()
        }
        if (golbalSceneNumber === 3) {
            showToolTip = true;
            showAnnotation1 = false;
            showAnnotation2 = false;
            showYearSelection = true;
            regionSelect = ""
            d3.select("#scene-desc")
                .html("<h2>Please use your mouse to explore now!</h2><br><p>You will get more information when your mouse is over" +
                    " any county.</p>")
            d3.select("#div_template").html("")
            d3.selectAll(".btn").attr("class", "btn btn-default")
            d3.select("#button3").attr("class", "btn btn-primary")
            init()
        }
    }

    async function init() {
        // create a tooltip
        var Tooltip = d3.select("#div_template")
            .append("div")
            .style("opacity", 0)
            .style("position", "absolute")
            .attr("class", "tooltip")
            .style("width", "120px")
            .style("height", "60px")
            .style("text-align", "center")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px");

        if (showAnnotation1) {
            var Annotation1_1 = d3.select("#div_template")
                .append("div")
                .attr("class", "annotation")
                .html("The <em>poorest</em> countries have <em>highest</em> birth rate")
                .style("left", "100px")
                .style("top", "10px")

            var Annotation1_2 = d3.select("#div_template")
                .append("div")
                .attr("class", "annotation")
                .html("The <em>richest</em> countries have <em>lowest</em> birth rate")
                .style("left", "750px")
                .style("top", "300px")
        }


        if (showAnnotation2) {
            var Annotation2 = d3.select("#div_template")
                .append("div")
                .attr("class", "annotation")
                .html("<em>European</em> countries all very low birth rate")
                .style("left", "550px")
                .style("top", "250px")
        }

        var mouseover = function (d) {
            Tooltip
                .style("opacity", 1)
            d3.select(this)
                .style("stroke", "green")
                .style("opacity", 1)
        };
        var mousemove = function (d) {
            Tooltip
                .html("The population of <em>" + d.Country + "</em><br/> is: " + d.Population)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 200) + "px")
        };
        var mouseleave = function (d) {
            Tooltip
                .style("opacity", 0)
            d3.select(this)
                .style("stroke", "black")
                .style("opacity", 0.2)
        };

        var highlight = function (d) {
            if ("" === regionSelect) {
                return 0.2;
            }
            if (d === regionSelect) {
                return 1;
            } else {
                return 0.05;
            }
        }
        var regions = ["Africa", "The Americas", "Asia", "Europe", "Middle East", "Oceania"];

        var ys = d3.scaleLinear().domain([0, 0.06]).range([height, 0]);
        var xs = d3.scaleLog().domain([100, 100000]).range([0, width]);
        var rs = d3.scaleLog().domain([30000, 1600000000]).range([0, 15]);
        var cs = d3.scaleOrdinal().domain(regions)
            .range(["gold", "blue", "green", "red", "brown", "slateblue", "orange"])

        data = await d3.csv("https://yukuo78.github.io/cs498/gdp_birth_pop_2012.csv");

        var svg = d3.select("#div_template").append("svg")
            .attr("width", (width + margin.left + margin.right))
            .attr("height", (height + margin.top + margin.bottom));

        var wrapper = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")")


        var circles = wrapper.selectAll("circle").data(data).enter().append("circle")
            .attr("cx", function (d) {
                return xs(d.Income);
            })
            .attr("cy", function (d) {
                return ys(d.BirthRate);
            })
            .attr("r", function (d) {
                return rs(Number(d.Population));
            })
            .attr("fill", function (d) {
                return cs(d.Region);
            })
            .style("opacity", function (d) {
                return highlight(d.Region);
            })
            if (showToolTip) {
                circles .on("mouseover", mouseover)
                .on("mousemove", mousemove)
                .on("mouseleave", mouseleave)
            }


        wrapper.append("g").attr("transform", "translate(0,0)")
            .call(d3.axisLeft(ys).ticks(5))
        // .tickValues([0.01, 0.02, 0.05, 0.08]))
        // .tickFormat(d3.format("~s")))

        wrapper.append("g").attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(xs).tickValues([10, 100, 1000, 10000, 100000]).tickFormat(d3.format("~s")))


        //Set up X axis label
        wrapper.append("g")
            .append("text")
            .attr("class", "x title")
            .attr("text-anchor", "end")
            .style("font-size", "12px")
            .attr("transform", "translate(" + width + "," + (height - 10) + ")")
            .text("GDP per capita [US $] - Logarithmic scale");

        //Set up y axis label
        wrapper.append("g")
            .append("text")
            .attr("class", "y title")
            .attr("text-anchor", "end")
            .style("font-size", "12px")
            .attr("transform", "translate(18, 0) rotate(-90)")
            .text("Birth rate");

        // add legend
        var legend = d3.select("svg").append("g")
            .attr("class", "legend")
            .attr("x", width)
            .attr("y", 25)
            .attr("height", 100)
            .attr("width", 100);

        legend.selectAll('g').data(regions)
            .enter()
            .append('g')
            .each(function (d, i) {
                var g = d3.select(this);
                g.append("rect")
                    .attr("x", width - 50)
                    .attr("y", (i + 1) * 25)
                    .attr("width", 10)
                    .attr("height", 10)
                    .style("fill", cs(d));

                g.append("text")
                    .attr("x", width - 25)
                    .attr("y", (i + 1) * 25 + 8)
                    .attr("height", 30)
                    .attr("width", 100)
                    .style("fill", "black")
                    .text(d);

            });

    }
</script>
</body>
</html>
